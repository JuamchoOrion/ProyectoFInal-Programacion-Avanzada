<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat Test Multiusuario</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    input, button { margin: 5px; }
    ul { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; }
    li { margin: 5px 0; padding: 5px; border-radius: 5px; }
    .sent { background: #d1ffd1; }
    .received { background: #f0f0f0; }
  </style>
</head>
<body>
<h1>Chat Test Multiusuario</h1>

<label>JWT del usuario:</label><br>
<input type="text" id="tokenInput" style="width:400px">
<button onclick="connect()">Conectar</button>
<button onclick="disconnect()">Desconectar</button>
<hr>

<label>Receptor ID (UUID):</label><br>
<input type="text" id="receiverId" style="width:400px"><br>

<label>Mensaje:</label><br>
<input type="text" id="message" style="width:400px"><br>
<button onclick="sendMessage()">Enviar Mensaje</button>

<h3>Mensajes:</h3>
<ul id="messages"></ul>

<script>
  let stompClient = null;
  let myUserId = null;

  function parseJwt(token) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.sub;
    } catch (e) {
      alert("JWT inválido");
      return null;
    }
  }

  function connect() {
    const token = document.getElementById("tokenInput").value.trim();
    if (!token) { alert("Ingresa un token"); return; }

    myUserId = parseJwt(token);
    if (!myUserId) return;

    const socket = new SockJS('http://localhost:9090/chat-websocket');
    stompClient = Stomp.over(socket);

    stompClient.connect({ 'Authorization': 'Bearer ' + token }, function(frame) {
      console.log("Conectado: " + frame);
      document.getElementById("messages").innerHTML = "";

      stompClient.subscribe('/topic/chat/' + myUserId, function(message) {
        const msg = JSON.parse(message.body);
        const li = document.createElement("li");
        li.textContent = "De " + msg.senderId + ": " + msg.content;
        li.className = "received";
        document.getElementById("messages").appendChild(li);
      });
    }, function(error) {
      console.error("Error al conectar:", error);
      alert("No se pudo conectar: " + error);
    });
  }

  function disconnect() {
    if (stompClient) {
      stompClient.disconnect();
      stompClient = null;
      myUserId = null;
      document.getElementById("messages").innerHTML = "";
      alert("Desconectado");
    }
  }

  function sendMessage() {
    if (!stompClient || !myUserId) { alert("Debes conectarte primero"); return; }

    const receiverId = document.getElementById("receiverId").value.trim();
    const content = document.getElementById("message").value.trim();
    if (!receiverId || !content) { alert("Receptor y mensaje son obligatorios"); return; }

    const mensaje = { receiverId, content };
    stompClient.send("/app/send", {}, JSON.stringify(mensaje));

    const li = document.createElement("li");
    li.textContent = "Tú → " + receiverId + ": " + content;
    li.className = "sent";
    document.getElementById("messages").appendChild(li);

    document.getElementById("message").value = "";
  }
</script>
</body>
</html>
